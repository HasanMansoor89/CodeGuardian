import { useState } from 'react';
import { ChevronDown, ChevronUp, FileCode, AlertTriangle, ExternalLink, Flag, Lightbulb, BookOpen, ShieldAlert } from 'lucide-react';
import { Vulnerability, ExplanationLevel, ConfidenceLevel } from '@/types/security';
import { Badge } from '@/components/ui/badge';
import { Button } from '@/components/ui/button';
import { Collapsible, CollapsibleContent, CollapsibleTrigger } from '@/components/ui/collapsible';
import { CopyButton } from '@/components/CopyButton';
import { ConfidenceBadge } from '@/components/ConfidenceBadge';
import { Tooltip, TooltipContent, TooltipProvider, TooltipTrigger } from '@/components/ui/tooltip';

interface VulnerabilityCardProps {
  vulnerability: Vulnerability;
  explanationLevel: ExplanationLevel;
  isOpen?: boolean;
  onToggle?: (isOpen: boolean) => void;
  onMarkFalsePositive?: (id: string) => void;
}

// Real-world examples for beginners
const realWorldExamples: Record<string, string> = {
  'CWE-798': 'In 2019, a major airline exposed API keys in their mobile app, leading to unauthorized access to customer data.',
  'CWE-89': 'The 2017 Equifax breach affected 147M people due to SQL injection vulnerabilities.',
  'CWE-79': 'XSS vulnerabilities in social platforms have been used to spread malware and steal session tokens.',
  'CWE-22': 'Path traversal in a file upload feature allowed attackers to overwrite server configuration.',
};

// Simple analogies for complex concepts
const simpleAnalogies: Record<string, string> = {
  'CWE-798': "It's like writing your house key's code on a sticky note attached to your front door.",
  'CWE-89': "It's like a librarian who follows any instruction on a library card, even malicious ones.",
  'CWE-79': "It's like someone slipping their own script into a play without the director noticing.",
  'CWE-22': "It's like following directions that lead outside the allowed area of a building.",
};

export function VulnerabilityCard({ 
  vulnerability, 
  explanationLevel, 
  isOpen: controlledOpen, 
  onToggle,
  onMarkFalsePositive 
}: VulnerabilityCardProps) {
  const [markedFP, setMarkedFP] = useState(vulnerability.isFalsePositive || false);
  const isControlled = controlledOpen !== undefined;
  const isOpen = isControlled ? controlledOpen : false;

  const explanation = explanationLevel === 'beginner' 
    ? vulnerability.beginnerExplanation 
    : vulnerability.expertExplanation;

  const likelihoodColors = {
    low: 'text-severity-low',
    medium: 'text-severity-medium',
    high: 'text-severity-high',
  };

  const handleOpenChange = (open: boolean) => {
    if (onToggle) {
      onToggle(open);
    }
  };

  const handleMarkFP = (e: React.MouseEvent) => {
    e.stopPropagation();
    setMarkedFP(!markedFP);
    onMarkFalsePositive?.(vulnerability.id);
  };

  const cweId = vulnerability.cweReference?.replace('CWE-', '') || '';
  const realWorldExample = realWorldExamples[vulnerability.cweReference || ''];
  const analogy = simpleAnalogies[vulnerability.cweReference || ''];

  // Determine confidence level (default to medium if not provided)
  const confidence: ConfidenceLevel = vulnerability.confidenceLevel || 'medium';

  return (
    <div className={`animate-fade-in rounded-lg border transition-all hover:border-primary/30 ${
      markedFP 
        ? 'border-muted bg-muted/30 opacity-60' 
        : 'border-border bg-card'
    }`}>
      <Collapsible open={isOpen} onOpenChange={handleOpenChange}>
        <CollapsibleTrigger asChild>
          <Button
            variant="ghost"
            className="flex h-auto w-full items-start justify-between p-4 text-left hover:bg-muted/50"
          >
            <div className="flex-1 space-y-2">
              <div className="flex flex-wrap items-center gap-2">
                <Badge variant={vulnerability.severity}>{vulnerability.severity.toUpperCase()}</Badge>
                <span className={`text-xs ${likelihoodColors[vulnerability.exploitLikelihood]}`}>
                  {vulnerability.exploitLikelihood} exploit likelihood
                </span>
                <ConfidenceBadge level={confidence} />
                {vulnerability.cweReference && (
                  <Badge variant="outline" className="text-xs">
                    {vulnerability.cweReference}
                  </Badge>
                )}
                {vulnerability.owaspCategory && (
                  <Badge variant="outline" className="text-xs bg-primary/5">
                    {vulnerability.owaspCategory}
                  </Badge>
                )}
                {markedFP && (
                  <Badge variant="outline" className="text-xs bg-muted">
                    <Flag className="h-2.5 w-2.5 mr-1" />
                    False Positive
                  </Badge>
                )}
              </div>
              <h3 className="font-semibold text-foreground">{vulnerability.title}</h3>
              <div className="flex items-center gap-4 text-sm text-muted-foreground">
                <span className="flex items-center gap-1">
                  <FileCode className="h-3 w-3" />
                  {vulnerability.file}
                </span>
                {vulnerability.function && (
                  <span>fn: {vulnerability.function}</span>
                )}
                <span>Line {vulnerability.line}</span>
              </div>
            </div>
            {isOpen ? (
              <ChevronUp className="h-5 w-5 shrink-0 text-muted-foreground" />
            ) : (
              <ChevronDown className="h-5 w-5 shrink-0 text-muted-foreground" />
            )}
          </Button>
        </CollapsibleTrigger>

        <CollapsibleContent>
          <div className="space-y-4 border-t border-border px-4 py-4">
            {/* Risk Score Explanation */}
            {vulnerability.riskScoreExplanation && (
              <div className="rounded-lg bg-muted/30 p-3 border border-border/50">
                <h4 className="mb-1 flex items-center gap-2 text-xs font-medium text-muted-foreground uppercase tracking-wide">
                  <ShieldAlert className="h-3.5 w-3.5" />
                  Why this severity?
                </h4>
                <p className="text-sm text-foreground">{vulnerability.riskScoreExplanation}</p>
              </div>
            )}

            {/* Explanation */}
            <div>
              <h4 className="mb-2 flex items-center gap-2 text-sm font-medium text-foreground">
                <AlertTriangle className="h-4 w-4 text-severity-medium" />
                {explanationLevel === 'beginner' ? 'What This Means' : 'Technical Analysis'}
              </h4>
              <p className="text-sm leading-relaxed text-muted-foreground">{explanation}</p>
            </div>

            {/* Beginner: Simple Analogy */}
            {explanationLevel === 'beginner' && analogy && (
              <div className="rounded-lg bg-primary/5 border border-primary/20 p-3">
                <h4 className="mb-1 flex items-center gap-2 text-xs font-medium text-primary">
                  <Lightbulb className="h-3.5 w-3.5" />
                  Simple Analogy
                </h4>
                <p className="text-sm text-foreground">{analogy}</p>
              </div>
            )}

            {/* Beginner: Real-world example */}
            {explanationLevel === 'beginner' && realWorldExample && (
              <div className="rounded-lg bg-severity-medium/5 border border-severity-medium/20 p-3">
                <h4 className="mb-1 flex items-center gap-2 text-xs font-medium text-severity-medium">
                  <BookOpen className="h-3.5 w-3.5" />
                  Real-World Impact
                </h4>
                <p className="text-sm text-foreground">{realWorldExample}</p>
              </div>
            )}

            {/* Vulnerable Code with context */}
            <div className="group relative">
              <div className="flex items-center justify-between mb-2">
                <h4 className="text-sm font-medium text-foreground">Vulnerable Code</h4>
                <CopyButton text={vulnerability.codeSnippet} />
              </div>
              <pre className="overflow-x-auto rounded-lg bg-code p-4 scrollbar-thin">
                <code className="font-mono text-sm text-code-foreground">{vulnerability.codeSnippet}</code>
              </pre>
              {vulnerability.contextLines && (
                <details className="mt-2">
                  <summary className="text-xs text-muted-foreground cursor-pointer hover:text-foreground">
                    Show surrounding context
                  </summary>
                  <pre className="mt-2 overflow-x-auto rounded-lg bg-muted/30 p-3 scrollbar-thin">
                    <code className="font-mono text-xs text-muted-foreground">{vulnerability.contextLines}</code>
                  </pre>
                </details>
              )}
            </div>

            {/* Secure Refactoring */}
            <div className="group relative">
              <div className="flex items-center justify-between mb-2">
                <h4 className="text-sm font-medium text-status-secure">
                  {explanationLevel === 'expert' ? 'Secure Pattern' : 'Secure Refactoring'}
                </h4>
                <CopyButton text={vulnerability.secureRefactoring} />
              </div>
              <pre className="overflow-x-auto rounded-lg border border-status-secure/20 bg-status-secure/5 p-4 scrollbar-thin">
                <code className="font-mono text-sm text-code-foreground">{vulnerability.secureRefactoring}</code>
              </pre>
            </div>

            {/* References and Actions */}
            <div className="flex flex-wrap items-center justify-between gap-2 pt-2 border-t border-border/50">
              <div className="flex flex-wrap gap-2">
                {vulnerability.cweReference && (
                  <a
                    href={`https://cwe.mitre.org/data/definitions/${cweId}.html`}
                    target="_blank"
                    rel="noopener noreferrer"
                    className="inline-flex items-center gap-1 text-xs text-primary hover:underline"
                  >
                    CWE-{cweId} Reference
                    <ExternalLink className="h-3 w-3" />
                  </a>
                )}
                {vulnerability.owaspCategory && (
                  <a
                    href="https://owasp.org/Top10/"
                    target="_blank"
                    rel="noopener noreferrer"
                    className="inline-flex items-center gap-1 text-xs text-primary hover:underline"
                  >
                    OWASP Top 10
                    <ExternalLink className="h-3 w-3" />
                  </a>
                )}
              </div>
              
              {/* False Positive action */}
              <TooltipProvider>
                <Tooltip>
                  <TooltipTrigger asChild>
                    <Button
                      variant="ghost"
                      size="sm"
                      className={`text-xs ${markedFP ? 'text-severity-medium' : 'text-muted-foreground'}`}
                      onClick={handleMarkFP}
                    >
                      <Flag className="h-3 w-3 mr-1" />
                      {markedFP ? 'Unmark' : 'False positive'}
                    </Button>
                  </TooltipTrigger>
                  <TooltipContent>
                    <p>Mark this finding as a false positive</p>
                    <p className="text-xs text-muted-foreground">Does not affect statistics</p>
                  </TooltipContent>
                </Tooltip>
              </TooltipProvider>
            </div>
          </div>
        </CollapsibleContent>
      </Collapsible>
    </div>
  );
}
